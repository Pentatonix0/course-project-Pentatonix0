# Security Non-Functional Requirements (NFR)

| ID         | Название                   | Описание                                     | Метрика / Порог                                                          | Проверка                                            | Компонент     | Приоритет |
| ---------- | -------------------------- | -------------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------- | ------------- | --------- |
| NFR-SEC-01 | Хэширование паролей        | Безопасное хранение паролей пользователей    | Argon2id (m=64MB, t≥3, p≥1) или bcrypt cost≥12                           | Юнит-тест параметров; ревью кода auth_core          | Auth          | P1        |
| NFR-SEC-02 | TTL и алгоритм JWT         | Безопасные токены доступа и обновления       | Access TTL=15m; Refresh TTL=7d; alg=HS256; секрет ≥32 байт; ротация ≤90d | Тесты конфигурации; проверка exp/alg; секрет из env | Auth          | P1        |
| NFR-SEC-03 | Покрытие аутентификацией   | Модифицирующие эндпоинты закрыты JWT         | 100% POST/PATCH/DELETE имеют security в OpenAPI                          | Тест проверки OpenAPI security                      | API Gateway   | P1        |
| NFR-SEC-04 | Ограничение логина         | Защита от брутфорса на /auth/login           | ≤5 req/min на IP; блок 15m после 10 ошибок                               | Интеграционный тест 429; конфиг rate-limiter        | Auth          | P1        |
| NFR-SEC-05 | Валидация входных данных   | Запрет лишних полей и типобезопасность DTO   | Все DTO: extra=forbid; 0 успешных кейсов с лишними полями                | Тесты 422 на extra fields; OpenAPI сверка           | API           | P2        |
| NFR-SEC-06 | Секреты и ротация          | Исключить секреты в репозитории              | CI gitleaks=0; ротация секрета JWT ≤90d                                  | pre-commit/CI; чек-лист ротации                     | CI/Config     | P1        |
| NFR-SEC-07 | Уязвимости зависимостей    | Критичные/высокие блокируют релиз            | 0 Critical/High по pip-audit/safety; Age High<14d                        | Шаг CI pip-audit/safety — fail on High+             | CI            | P1        |
| NFR-SEC-08 | Ошибки без утечек          | Без стектрейсов/секретов наружу              | Ответы 5xx не содержат Traceback/секретов                                | Интеграционный тест 500 → sanitized JSON            | API           | P2        |
| NFR-SEC-09 | CORS политика              | Только доверенные источники                  | Разрешены origins из allowlist                                           | Тест настроек/заголовков                            | API           | P3        |
| NFR-SEC-10 | Аудит-логирование          | Фиксация важных событий (login/logout, CRUD) | Все события фиксируются; PII редактируется                               | Юнит-тест caplog на события                         | Observability | P3        |
| NFR-SEC-11 | Резервные копии БД         | Восстановление после потерь                  | Backup daily; Retention 7d; шифрование в хранении                        | Док-процедура; тест восстановления (dev)            | DB/Ops        | P4        |
| NFR-SEC-12 | Конфиденциальность токенов | Не логировать токены и секреты               | 0 вхождений по маскам в логах                                            | pre-commit regex; тест caplog redaction             | API/Logs      | P2        |
