name: Security - SAST & Secrets

on:
    workflow_dispatch:
    push:
        paths:
            - '**/*.py'
            - 'requirements*.txt'
            - 'security/**'
            - '.github/workflows/ci-sast-secrets.yml'
    pull_request:
        paths:
            - '**/*.py'
            - 'requirements*.txt'
            - 'security/**'
            - '.github/workflows/ci-sast-secrets.yml'

permissions:
    contents: read

concurrency:
    group: sast-secrets-${{ github.ref }}
    cancel-in-progress: true

jobs:
    sast-secrets:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Ensure evidence and config directories
              run: mkdir -p EVIDENCE/P10 security/semgrep

            - name: Semgrep SAST (SARIF)
              run: |
                  docker run --rm -v ${{ github.workspace }}:/src returntocorp/semgrep:latest \
                    semgrep ci --config p/ci --config /src/security/semgrep/rules.yml \
                    --sarif --output /src/EVIDENCE/P10/semgrep.sarif --metrics=off || true

            - name: Gitleaks secrets scan
              run: |
                  docker run --rm -v ${{ github.workspace }}:/repo zricethezav/gitleaks:latest \
                    detect --no-banner --config=/repo/security/.gitleaks.toml \
                    --source=/repo --report-format=json --report-path=/repo/EVIDENCE/P10/gitleaks.json || true

            - name: Upload SAST & secrets artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: p10-sast-secrets
                  path: |
                      EVIDENCE/P10/semgrep.sarif
                      EVIDENCE/P10/gitleaks.json
